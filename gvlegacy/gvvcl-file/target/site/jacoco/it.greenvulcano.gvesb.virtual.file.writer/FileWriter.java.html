<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileWriter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GreenVulcano VCL File Plugin</a> &gt; <a href="index.source.html" class="el_package">it.greenvulcano.gvesb.virtual.file.writer</a> &gt; <span class="el_source">FileWriter.java</span></div><h1>FileWriter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2009-2017 GreenVulcano ESB Open Source Project. All rights
 * reserved.
 * 
 * This file is part of GreenVulcano ESB.
 * 
 * GreenVulcano ESB is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the
 * Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 * 
 * GreenVulcano ESB is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License
 * for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with GreenVulcano ESB. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package it.greenvulcano.gvesb.virtual.file.writer;

import it.greenvulcano.configuration.XMLConfig;
import it.greenvulcano.configuration.XMLConfigException;
import it.greenvulcano.gvesb.buffer.GVBuffer;
import it.greenvulcano.gvesb.internal.data.GVBufferPropertiesHelper;
import it.greenvulcano.gvesb.virtual.CallException;
import it.greenvulcano.gvesb.virtual.CallOperation;
import it.greenvulcano.gvesb.virtual.ConnectionException;
import it.greenvulcano.gvesb.virtual.InitializationException;
import it.greenvulcano.gvesb.virtual.InvalidDataException;
import it.greenvulcano.gvesb.virtual.OperationKey;
import it.greenvulcano.util.bin.BinaryUtils;
import it.greenvulcano.util.metadata.PropertiesHandler;
import it.greenvulcano.util.txt.TextUtils;
import it.greenvulcano.util.xml.XMLUtils;

import java.io.File;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Node;

/**
 * Write GVBuffer.object (if contains byte array, String or Node) in a file.
 * 
 * @version 4.0.0 Mar, 2017
 * @author GreenVulcano Developer Team
 * 
 * 
 */
<span class="fc" id="L52">public class FileWriter implements CallOperation</span>
{

<span class="fc" id="L55">    private static final Logger logger     = LoggerFactory.getLogger(FileWriter.class);</span>

    /**
     * The instance name.
     */
<span class="fc" id="L60">    private String              name       = null;</span>

    /**
     * The pathname for the target directory. Can contain placeholders that will
     * be replaced at call time. Must evaluate to an absolute pathname.
     */
<span class="fc" id="L66">    private String              targetPath = null;</span>

    /**
     * Source file name. Can contain placeholders that will be expanded at call
     * time.
     */
<span class="fc" id="L72">    private String              filename   = null;</span>

    /**
     * Enable append data mode.
     */
<span class="fc" id="L77">    private boolean             append     = false;</span>

    /**
     * The optional EOL to append if 'append' is true.
     */
<span class="fc" id="L82">    private String              appendEOL  = null;</span>

    /**
     * the operation key
     */
<span class="fc" id="L87">    protected OperationKey      key        = null;</span>

    /**
     * Invoked from &lt;code&gt;OperationFactory&lt;/code&gt; when an &lt;code&gt;Operation&lt;/code&gt;
     * needs initialization.&lt;br&gt;
     *
     * @param node
     * 			The configuration node containing all informations.
     *
     * @see it.greenvulcano.gvesb.virtual.Operation#init(org.w3c.dom.Node)
     * 
     * @throws InitializationException
     */
    @Override
    public void init(Node node) throws InitializationException
    {
        try {
<span class="fc" id="L104">            name = XMLConfig.get(node, &quot;@name&quot;);</span>
<span class="fc" id="L105">            targetPath = XMLConfig.get(node, &quot;@targetPath&quot;);</span>
<span class="fc" id="L106">            filename = XMLConfig.get(node, &quot;@fileName&quot;);</span>
<span class="fc" id="L107">            append = XMLConfig.getBoolean(node, &quot;@append&quot;, false);</span>
<span class="fc" id="L108">            String eol = XMLConfig.get(node, &quot;@appendEOL&quot;, null);</span>

<span class="fc" id="L110">            logger.debug(&quot;targetPath : &quot; + targetPath);</span>
<span class="fc" id="L111">            logger.debug(&quot;filename   : &quot; + filename);</span>
<span class="fc" id="L112">            logger.debug(&quot;append     : &quot; + append);</span>
<span class="pc bpc" id="L113" title="3 of 4 branches missed.">            if (append &amp;&amp; (eol != null)) {</span>
<span class="nc" id="L114">                logger.debug(&quot;appendEOL  : &quot; + eol);</span>
<span class="nc" id="L115">                appendEOL = TextUtils.getEOL(eol);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (appendEOL == null) {</span>
<span class="nc" id="L117">                    throw new Exception(&quot;Invalid appendEOL value [&quot; + eol + &quot;]&quot;);</span>
                }
            }

<span class="fc" id="L121">            logger.debug(&quot;FileWriter &quot; + name + &quot; configured&quot;);</span>
        }
<span class="nc" id="L123">        catch (XMLConfigException exc) {</span>
<span class="nc" id="L124">            logger.error(&quot;An error occurred while reading configuration&quot;, exc);</span>
<span class="nc" id="L125">            throw new InitializationException(&quot;GV_CONFIGURATION_ERROR&quot;, new String[][]{{&quot;message&quot;, exc.getMessage()}},</span>
                    exc);
        }
<span class="nc" id="L128">        catch (Exception exc) {</span>
<span class="nc" id="L129">            logger.error(&quot;A generic error occurred while initializing&quot;, exc);</span>
<span class="nc" id="L130">            throw new InitializationException(&quot;GV_CONFIGURATION_ERROR&quot;, new String[][]{{&quot;message&quot;, exc.getMessage()}},</span>
                    exc);
<span class="fc" id="L132">        }</span>
<span class="fc" id="L133">    }</span>

    /**
     * @param gvBuffer 
     * 			The GVBuffer to be used within the service
     * @return the GVBuffer
     * 
     * @see it.greenvulcano.gvesb.virtual.CallOperation#perform(it.greenvulcano.gvesb.buffer.GVBuffer)
     * 
     * @throws ConnectionException, CallException, InvalidDataException
     */
    @Override
    public GVBuffer perform(GVBuffer gvBuffer) throws ConnectionException, CallException, InvalidDataException
    {
        try {
<span class="fc" id="L148">            File targetFile = buildTargetPathname(gvBuffer);</span>

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            logger.debug(&quot;Writing &quot; + (append ? &quot;(in append mode) &quot; : &quot;&quot;) + &quot;file: &quot; + targetFile.getAbsolutePath());</span>
<span class="fc" id="L151">            Object data = gvBuffer.getObject();</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L153">                throw new InvalidDataException(&quot;The GVBuffer content is NULL&quot;);</span>
            }
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">            if (data instanceof byte[]) {</span>
<span class="nc" id="L156">                BinaryUtils.writeBytesToFile((byte[]) data, targetFile, append);</span>
            }
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            else if (data instanceof String) {</span>
<span class="fc" id="L159">                TextUtils.writeFile((String) data, targetFile, append);</span>
            }
<span class="nc bnc" id="L161" title="All 2 branches missed.">            else if (data instanceof Node) {</span>
<span class="nc" id="L162">                BinaryUtils.writeBytesToFile(XMLUtils.serializeDOMToByteArray_S((Node) data), targetFile, append);</span>
            }
            else {
<span class="nc" id="L165">                throw new InvalidDataException(&quot;Invalid GVBuffer content: &quot; + data.getClass().getName());</span>
            }

<span class="pc bpc" id="L168" title="3 of 4 branches missed.">            if (append &amp;&amp; (appendEOL != null)) {</span>
<span class="nc" id="L169">                TextUtils.writeFile(appendEOL, targetFile, append);</span>
            }

<span class="fc" id="L172">            return gvBuffer;</span>
        }
<span class="nc" id="L174">        catch (Exception exc) {</span>
<span class="nc" id="L175">            logger.error(&quot;An error occurred while writing file&quot;, exc);</span>
<span class="nc" id="L176">            throw new CallException(&quot;GV_CALL_SERVICE_ERROR&quot;, new String[][]{{&quot;service&quot;, gvBuffer.getService()},</span>
<span class="nc" id="L177">                    {&quot;system&quot;, gvBuffer.getSystem()}, {&quot;id&quot;, gvBuffer.getId().toString()},</span>
<span class="nc" id="L178">                    {&quot;message&quot;, exc.getMessage()}}, exc);</span>
        }
    }


    /**
     * do nothing
     * 
     * @see it.greenvulcano.gvesb.virtual.Operation#cleanUp()
     */
    @Override
    public void cleanUp()
    {
        // do nothing
<span class="nc" id="L192">    }</span>

    /**
     * do nothing
     * 
     * @see it.greenvulcano.gvesb.virtual.Operation#destroy()
     */
    @Override
    public void destroy()
    {
        // do nothing
<span class="nc" id="L203">    }</span>

    /**
     * Set the configured operation key
     * 
     * @param key
     * 			the configured operation key
     * 
     * @see it.greenvulcano.gvesb.virtual.Operation#setKey(it.greenvulcano.gvesb.virtual.OperationKey)
     */
    @Override
    public void setKey(OperationKey key)
    {
<span class="nc" id="L216">        this.key = key;</span>
<span class="nc" id="L217">    }</span>

    /**
     * Return the configured operation key
     * 
     * @return key
     * 			the configured operation key
     * 
     * @see it.greenvulcano.gvesb.virtual.Operation#getKey()
     */
    @Override
    public OperationKey getKey()
    {
<span class="nc" id="L230">        return key;</span>
    }

    /**
     * Return the services of gvBuffer
     * 
     * @return the service of gvBuffer
     * 
     * @param gvBuffer
     * 			The GVBuffer to be used within the service
     * 
     * @see it.greenvulcano.gvesb.virtual.Operation#getServiceAlias(it.greenvulcano.gvesb.buffer.GVBuffer)
     */
    @Override
    public String getServiceAlias(GVBuffer gvBuffer)
    {
<span class="nc" id="L246">        return gvBuffer.getService();</span>
    }

    private File buildTargetPathname(GVBuffer gvBuffer) throws Exception
    {
        try {
<span class="fc" id="L252">            PropertiesHandler.enableExceptionOnErrors();</span>
<span class="fc" id="L253">            Map&lt;String, Object&gt; params = GVBufferPropertiesHelper.getPropertiesMapSO(gvBuffer, true);</span>

<span class="fc" id="L255">            String targetDirectory = gvBuffer.getProperty(&quot;GVFW_DIRECTORY&quot;);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">            if (targetDirectory == null) {</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">                if (targetPath != null) {</span>
<span class="fc" id="L258">                    targetDirectory = targetPath;</span>
                }
                else {
<span class="nc" id="L261">                    throw new IllegalArgumentException(&quot;Pathname NOT available&quot;);</span>
                }
            }


<span class="fc" id="L266">            targetDirectory = PropertiesHandler.expand(targetDirectory, params, gvBuffer);</span>

<span class="fc" id="L268">            String targetFilename = gvBuffer.getProperty(&quot;GVFW_FILE_NAME&quot;);</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">            if (targetFilename == null) {</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">                if (filename != null) {</span>
<span class="fc" id="L271">                    targetFilename = filename;</span>
                }
                else {
<span class="nc" id="L274">                    throw new IllegalArgumentException(&quot;File NOT available&quot;);</span>
                }
            }

<span class="fc" id="L278">            targetFilename = PropertiesHandler.expand(targetFilename, params, gvBuffer);</span>

<span class="fc" id="L280">            File targetPathname = new File(targetDirectory, targetFilename);</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">            if (targetPathname.isAbsolute()) {</span>
<span class="pc bpc" id="L282" title="5 of 6 branches missed.">                if (!targetPathname.exists() || (targetPathname.exists() &amp;&amp; targetPathname.isFile())) {</span>
<span class="fc" id="L283">                    return targetPathname;</span>
                }
<span class="nc" id="L285">                throw new IllegalArgumentException(&quot;Pathname &quot; + targetPathname.getPath() + &quot; not a file&quot;);</span>
            }
<span class="nc" id="L287">            throw new IllegalArgumentException(&quot;Pathname &quot; + targetPathname.getPath() + &quot; is not absolute&quot;);</span>
        }
        finally {
<span class="pc" id="L290">            PropertiesHandler.disableExceptionOnErrors();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>